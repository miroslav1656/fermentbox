#include <Arduino.h>
#include <WiFi.h>
#include <WebServer.h>
#include <Preferences.h>

#include "config.h"
#include "sensors.h"
#include "control.h"

//------------------------------------------------------
//  WiFi credentials - uložené v NVS
//------------------------------------------------------
static char wifiSSID[64] = "Rehakovi";
static char wifiPass[64] = "123789Lucinka";

//------------------------------------------------------
//  Fallback AP mód
//------------------------------------------------------
static const char *AP_SSID = "FermentorBox";
static const char *AP_PASS = "fermentor123";

//------------------------------------------------------
static WebServer server(80);

//------------------------------------------------------
// Historie pro graf - ukládá se na ESP32
//------------------------------------------------------
#define HISTORY_SIZE 120
static float historyTemp[HISTORY_SIZE];
static float historyHum[HISTORY_SIZE];
static uint32_t historyTime[HISTORY_SIZE];
static int historyIndex = 0;
static int historyCount = 0;
static uint32_t lastHistorySample = 0;

static void addHistorySample() {
  uint32_t now = millis();
  if (now - lastHistorySample < 3000) return;
  lastHistorySample = now;

  float t1 = sensors.temp1;
  float t2 = sensors.temp2;
  float avgTemp = NAN;
  
  if (!isnan(t1) && !isnan(t2)) {
    avgTemp = (t1 + t2) * 0.5f;
  } else if (!isnan(t1)) {
    avgTemp = t1;
  } else if (!isnan(t2)) {
    avgTemp = t2;
  }

  historyTemp[historyIndex] = avgTemp;
  historyHum[historyIndex] = sensors.humidity;
  historyTime[historyIndex] = now / 1000;

  historyIndex = (historyIndex + 1) % HISTORY_SIZE;
  if (historyCount < HISTORY_SIZE) historyCount++;
}
